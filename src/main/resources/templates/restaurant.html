<html lang="en">
<head>
    <meta charSet="UTF-8">
    <title>Restaurant</title>
    <style>
        @import url(//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css);

        body { margin: 0; padding: 0; overflow: auto; }
        .--header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background-color: #FFE08C;font-family: "Black Han Sans", ui-rounded;font-weight: bold;}
        .container {width: auto;min-height: calc(90vh - (40px + (10px * 2)));display: flex;flex-direction: column;justify-content: center;align-items: center;padding: 35px;}
        .--logo-image {font-size: 30px;}
        .--login-container a {margin-left: 10px;}
        .--main {padding: 20px;}
        .--footer {text-align: center;padding: 10px;background-color: #f2f2f2;}
        .grid-container {display: inline-flex;gap: 20px;margin-bottom: 20px;justify-content: center;}
        .grid-item {background-color: #f9f9f9;padding: 40px;border-bottom: 20px;width: 400px;height: auto;font-size: 18px;border-radius: 5px;box-shadow: rgba(0, 0, 0, 0.1) 0px 4px 6px;}

        /* Ratings & WishList */

        .rate { display: inline-block; border: 0; margin-left: 0px; }
        .rate > input { display: none; }
        .rate > label { float: right; color: #ddd; }
        .rate > label:before {display: inline-block;font-size: 2rem;padding: .3rem .2rem;margin: 0;cursor: pointer;font-family: FontAwesome;content: "\f005 ";}
        .wishlist { display: inline-block; border: 0; margin-left: 0px; }
        .wishlist > h1 > input { display: none; }
        .wishlist > h1 > label { color: #ddd }
        .wishlist > h1 > label:before { display: inline-block; font-size: 2rem; padding: .3rem .2rem; margin: 0; cursor: pointer; font-family: FontAwesome, serif; content: "\f004 "; }
        .wishlist input:checked ~ label,
        .wishlist label:hover ~ input:checked ~ label { color: #F781F3 !important; }
    </style>
</head>

<body>
<header class="--header">
    <div class="--logo">
        <div class="--logo-image">ğŸ” ë§›ìêµ­</div>
    </div>
    <!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒê³¼ ë§ˆì´í˜ì´ì§€ ë§í¬ -->
    <div class="--login-container">
        <!-- ë§ˆì´í˜ì´ì§€ì™€ ë¡œê·¸ì•„ì›ƒ ë§í¬ -->
        <a href="/myPage">ë§ˆì´ í˜ì´ì§€</a>
        <a href="#" id="logout-button" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
    <!-- ë¡œê·¸ì¸ ë§í¬ -->
    <div class="--not-login-container" style="display: none;">
        <a href="/login">ë¡œê·¸ì¸</a>
    </div>
</header>


<main class="--main">
    <div class="container">
        <div class="grid-container">
            <div class="grid-item">
                <fieldset class="wishlist">
                    <h1 style="display:flex; justify-content : space-between; align-items : center;">
                        <div id="name">[ìŒì‹ì  ì´ë¦„]</div>&nbsp;
                        <input type="checkbox" id="wish" onClick="addWish()"><label for="wish"></label>
                    </h1>
                </fieldset>
                <img id="img" style="width:300px; height:300px;" src="#">
            </div>
            <div class="grid-item">
                <br><br><br><br><br>
                <div id="address">[ì§€ë²ˆì£¼ì†Œ]</div>
                <div id="road-address">[ë„ë¡œëª… ì£¼ì†Œ]</div>
                <br>
                <div id="open-hours">ì˜ì—…ì‹œê°„:</div>
                <div id="tel">ì „í™”ë²ˆí˜¸:</div>
                <br><br>
                <fieldset class="rate">
                    <input type="radio" id="rating5" name="rating" value="5"><label for="rating5" title="5ì " id="rt5"></label>
                    <input type="radio" id="rating4" name="rating" value="4"><label for="rating4" title="4ì " id="rt4"></label>
                    <input type="radio" id="rating3" name="rating" value="3"><label for="rating3" title="3ì " id="rt3"></label>
                    <input type="radio" id="rating2" name="rating" value="2"><label for="rating2" title="2ì " id="rt2"></label>
                    <input type="radio" id="rating1" name="rating" value="1"><label for="rating1" title="1ì " id="rt1"></label>
                    <p style="color:#BDBDBD" id="rate-text">&nbsp;ë³„ì  : - ì </p>
                </fieldset>
            </div>
        </div>
        <div class="grid-container">
            <div class="grid-item">
                <h3>ë©”ë‰´</h3>
                <div id="menus">[ë©”ë‰´]</div>
            </div>
            <div class="grid-item">
                <h3 style="position: relative">ë¦¬ë·°
                    <p id="addReviewBtn" style="cursor: pointer; position: absolute; top: -25px; right: 0" onclick="toNewReview()"> â•</p>
                </h3>
                <div id="reviews">[ë¦¬ë·°]</div>
            </div>
        </div>
    </div>
</main>


<footer class="--footer">
    Â©2023 Mutsa-Backend-School-JDK17. All rights reserved.
</footer>


<script>
    let restaurantId;
    let username;

    window.onload = function () {
        const params = new URL(location.href).searchParams;
        getRestaurantInfo(params.get("name"), params.get("address"));
    }

    /* ì¦ê²¨ì°¾ê¸°(í•˜íŠ¸) ë²„íŠ¼ í´ë¦­ ì‹œ, ì‹¤í–‰ */
    function addWish() {
        if (!localStorage.getItem('token') && !sessionStorage.getItem('token')) {
            document.getElementById('wish').checked = false;
            alert('ì¦ê²¨ì°¾ê¸° ë“±ë¡ì€ ë¡œê·¸ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        } else {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            const status = document.getElementById('wish').checked;
            fetch(`/api/wishlist/${restaurantId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            })
                .then(res => {
                    if (!res.ok) {
                        console.log(res.json());
                    } else {
                        if (status) alert("ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        else alert("ì¦ê²¨ì°¾ê¸°ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    }
                })
        }
    }

    async function isWishList() {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');
        let response = await fetch(`/api/wishlist/${restaurantId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        });
        let data = await response.text();
        if (data.includes("true")) document.getElementById('wish').checked = true;
    }

    /* refreshTokenìœ¼ë¡œ accessToken ì¬ë°œê¸‰ */
    async function reissueToken() {
        if (!localStorage.getItem('token') && !sessionStorage.getItem('token')) {
            document.getElementById('wish').checked = false;
            console.log("user: anonymous");
        } else {
            let response = await fetch(`/api/reissue`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}
            });
            let data = await response.json();

            if (localStorage.getItem('autoLogin') === "T") {
                localStorage.removeItem('token');
                localStorage.setItem('token', data.accessToken);
            } else if (localStorage.getItem('autoLogin') === "F") {
                sessionStorage.removeItem('token');
                sessionStorage.setItem('token', data.accessToken);
            }
            getUsername(data.accessToken);
        }
    }

    async function getUsername(token) {
        let response = await fetch(`/api/username`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        });
        username = await response.text();
        getReviewsPaged(0);
    }

    function getReviewsPaged(page) {
        fetch(`/api/${restaurantId}/review?page=${page}&limit=5`, {
            method: 'GET', headers: {'Content-Type': 'application/json'}
        })
            .then(response => response.json())
            .then(data => {
                let rvs = "<br>";
                data.reviewPage.content.forEach(function (review) {
                    rvs += `<div style="background-color: #ddd; border-radius:10px; padding: 10px;"> ${review.username} : ${review.content}`;
                    let flag = 0;

                    review.imageUrl.forEach(function (url) {
                        if (flag++ == 0) rvs += "<br>";
                        rvs += `<img style="width: 100px; height:100px; margin: 7px 5px 5px 10px;" src="${url}" >`
                    });
                    rvs += `<br><div style="display: flex; flex-flow: row nowrap; justify-content: flex-end">${"â­ï¸".repeat(review.ratings)} &nbsp;`

                    /* ë³¸ì¸ ëŒ“ê¸€ì— ìˆ˜ì • ë²„íŠ¼ ì¶”ê°€ */
                    if (review.username == username)
                        rvs += `<a href='/review/edit?restaurantId=${restaurantId}&reviewId=${review.id}'><button>ìˆ˜ì •</button></a>`
                    rvs += `</div></div><br>`;
                });

                rvs += '<div style="display: flex; flex-flow: row nowrap; justify-content: center;">'
                for (let i = 0; i < data.reviewPage.totalPages; i++) {
                    if (page == i) rvs += `<a style="color: brown;">&nbsp;&nbsp;${i + 1}&nbsp;&nbsp;</a>`;
                    else rvs += `<a onClick="getReviewsPaged(${i})" style="cursor: pointer" >&nbsp;&nbsp;${i + 1}&nbsp;&nbsp;</a>`;
                }
                document.getElementById('reviews').innerHTML = rvs + `</div>`;
            });
    }

    function toNewReview () {
        window.location.href =`/review?restaurantId=${restaurantId}`;
    }

    function getRestaurantInfo(name, address) {
        return fetch(`/api/restaurant/detail?name=${name}&address=${address}`, {
            method: 'GET', headers: {'Content-Type': 'application/json'}
        })
            .then(response => response.json())
            .then(data => {
                if (!data.address) alert("not found");
                else {
                    restaurantId = data.id;
                    reissueToken();
                    if (localStorage.getItem('token') || sessionStorage.getItem('token')) isWishList();
                    else {
                        document.getElementById('addReviewBtn').style.display = 'none';
                        getReviewsPaged(0);
                    }

                    document.getElementById('name').innerHTML = data.name;
                    document.getElementById('img').src = data.restaurantImageList[0];
                    for (let i = 1; i < parseInt(data.avgRatings) + 1; i++)
                        document.getElementById("rt" + i).style.cssText = "color: #D7DF01";

                    document.getElementById('rate-text').innerHTML = `&nbsp;ë³„ì  : ${data.avgRatings}ì `;
                    document.getElementById('address').innerHTML = data.address;
                    document.getElementById('road-address').innerHTML = data.roadAddress;

                    document.getElementById('open-hours').innerHTML = "ì˜ì—…ì‹œê°„: " + data.openHours.slice(0, 2) + ":" + data.openHours.slice(2, 4)
                        + " ~ " + data.closeHours.slice(0, 2) + ":" + data.closeHours.slice(2, 4);
                    document.getElementById('tel').innerHTML = "ì „í™”ë²ˆí˜¸: " + data.tel;

                    const menuList = data.menuInfo.split("|");
                    let menuStr = '';
                    menuList.forEach((elm) => (menuStr += `<br><div style="background-color: #ddd; border-radius:10px; padding: 10px;">${elm}</div>`));
                    document.getElementById('menus').innerHTML = menuStr;
                }
            })
    }

    function logout() {
        const token = localStorage.getItem('token') || sessionStorage.getItem('token');

        return fetch(`/api/logout`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
            }
        })
            .then(response => {
                if (response.ok) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('autoLogin');
                    sessionStorage.removeItem('token');
                    sessionStorage.removeItem('autoLogin');
                    // ë¡œê·¸ì•„ì›ƒ ì„±ê³µ ì‹œ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ê³  ë’¤ë¡œê°€ê¸° ë§‰ê¸°
                    window.location.replace("/");
                    // ë¸Œë¼ìš°ì €ì˜ í˜ì´ì§€ ì´ë™ ê¸°ë¡ì„ ì œê±°
                    window.history.pushState({}, '', '/');
                } else {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', response.statusText);
                    // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ í† í° ì‚­ì œ í›„ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    localStorage.removeItem('token');
                    localStorage.removeItem('autoLogin');
                    sessionStorage.removeItem('token');
                    sessionStorage.removeItem('autoLogin');
                    window.location.href = '/';
                }
            })
            .catch(error => console.error('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error));
    }
</script>

</body>
</html>